<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>题库后台</title>
	<link rel="icon" href="data:," />

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.19.4/dist/reset.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.19.4/dist/antd.min.css" />
	<style>
		body { background:#f5f7fb; }
		.header { background:#fff; padding:12px 20px; border-bottom:1px solid #eee; position:sticky; top:0; z-index:10; }
		.container { max-width:1000px; margin:20px auto; padding:0 16px; }
		.footer { text-align:center; color:#999; padding:24px 0; }
	</style>
</head>
<body>
	<div id="root"></div>

	<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/antd@5/dist/antd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
	<script type="text/babel" data-presets="react">
		const { useState, useEffect } = React;
		const { Button, Card, Input, Form, message, Layout, Menu, Table, Modal, Space, Typography, Tag } = antd;
		const { Header, Content } = Layout;
		const { Title, Text } = Typography;

		function useHashRoute() {
			const [hash, setHash] = useState(window.location.hash || '#/login');
			useEffect(() => {
				const onHash = () => setHash(window.location.hash || '#/login');
				window.addEventListener('hashchange', onHash);
				return () => window.removeEventListener('hashchange', onHash);
			}, []);
			return [hash, (h) => window.location.hash = h];
		}

		function getTokenUser() {
			try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch { return null; }
		}
		function setTokenUser(u) { localStorage.setItem('user', JSON.stringify(u)); }
		function clearUser() { localStorage.removeItem('user'); }

		async function api(url, options={}) {
			const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
			if (!res.ok) throw new Error(await res.text());
			const ct = res.headers.get('content-type') || '';
			if (ct.includes('application/json')) return res.json();
			return res.text();
		}

		function App() {
			const [hash, nav] = useHashRoute();
			const user = getTokenUser();

			useEffect(() => {
				if (!user && !hash.startsWith('#/login')) nav('#/login');
			}, [hash]);

			return (
				<Layout>
					<div className="header">
						<div style={{ display:'flex', alignItems:'center', justifyContent:'space-between' }}>
							<Space>
								<Title level={4} style={{margin:0}}>题库后台</Title>
								{user && <Tag color="blue">{user.username}</Tag>}
							</Space>
							<Space>
								{user ? <Button onClick={()=>{clearUser(); nav('#/login');}}>退出登录</Button> : null}
							</Space>
						</div>
					</div>
					<Content>
						<div className="container">
							{!user ? <Login onSuccess={(u)=>{ setTokenUser(u); nav('#/questions'); }} /> : (
								hash.startsWith('#/questions') ? <Questions user={user} /> : <Login onSuccess={(u)=>{ setTokenUser(u); nav('#/questions'); }} />
							)}
						</div>
						<div className="footer">© {new Date().getFullYear()} 题库后台</div>
					</Content>
				</Layout>
			);
		}

		function Login({ onSuccess }) {
			const [isReg, setIsReg] = useState(false);
			const [loading, setLoading] = useState(false);
			const [form] = Form.useForm();

			const submit = async () => {
				try {
					const v = await form.validateFields();
					setLoading(true);
					if (isReg) {
						await api('/auth/register', { method:'POST', body: JSON.stringify(v) });
						message.success('注册成功，请登录');
						setIsReg(false);
					} else {
						const u = await api('/auth/login', { method:'POST', body: JSON.stringify(v) });
						message.success('登录成功');
						onSuccess(u);
					}
				} catch(e) {
					message.error(String(e.message || e));
				} finally {
					setLoading(false);
				}
			};

			return (
				<Card style={{ maxWidth:420, margin:'40px auto' }}>
					<Title level={4} style={{textAlign:'center'}}>{isReg ? '注册' : '登录'}</Title>
					<Form layout="vertical" form={form}>
						<Form.Item name="username" label="用户名" rules={[{ required:true, message:'请输入用户名'}]}>
							<Input placeholder="用户名" />
						</Form.Item>
						<Form.Item name="password" label="密码" rules={[{ required:true, message:'请输入密码'}]}>
							<Input.Password placeholder="密码" />
						</Form.Item>
						<Button type="primary" block loading={loading} onClick={submit}>{isReg ? '注册' : '登录'}</Button>
					</Form>
					<div style={{textAlign:'center', marginTop:12}}>
						<Button type="link" onClick={()=>setIsReg(!isReg)}>{isReg ? '去登录' : '去注册'}</Button>
					</div>
				</Card>
			);
		}

		function Questions({ user }) {
							const [list, setList] = useState([]);
				const [loading, setLoading] = useState(false);
				const [aiLoading, setAiLoading] = useState(false);
			const [genOpen, setGenOpen] = useState(false);
			const [genForm] = Form.useForm();
			const [manualOpen, setManualOpen] = useState(false);
			const [manualForm] = Form.useForm();
			const [selectedRowKeys, setSelectedRowKeys] = useState([]);
			const [edit, setEdit] = useState(null);
			const [editForm] = Form.useForm();

			const fetchList = async () => {
				setLoading(true);
				try {
											const data = await api('/questions');
					setList(data);
				} catch(e) {
					message.error(String(e.message || e));
				} finally {
					setLoading(false);
				}
			};

			useEffect(() => { fetchList(); }, []);

			const columns = [
				{ title:'标题', dataIndex:'title', width:200, render:(v)=> v||'-' },
				{ title:'类型', dataIndex:'type', width:120, render:(v)=> ({choice:'选择题', blank:'填空题', subjective:'主观题'}[v||'subjective']) },
				{ title:'状态', dataIndex:'status', width:120, render:(v)=> ({pending:'待审核', approved:'已通过', rejected:'已拒绝'}[v||'pending']) },
				{ title:'内容', dataIndex:'content', render:(v)=> <div style={{maxHeight:80, overflow:'auto', whiteSpace:'pre-wrap'}}>{v}</div> },
				{ title:'创建时间', dataIndex:'createdAt', width:200, render:(v)=> new Date(v).toLocaleString() },
				{ title:'操作', key:'actions', width:280, render:(_,r)=> <Space>
					<Button onClick={()=>{ setEdit(r); editForm.setFieldsValue({ title:r.title, content:r.content, type:r.type||'subjective', options:r.options||[''], correctAnswers:r.correctAnswers||[], answer:r.answer||'' }); }}>编辑</Button>
					<Button onClick={()=> approveOne(r.id)} disabled={r.status==='approved'}>审核通过</Button>
					<Button danger onClick={()=> delRow(r.id)}>删除</Button>
				</Space>}
			];

											const genQuick = async () => {
					setAiLoading(true);
					try {
						await api('/questions/generate', { method:'POST', body: JSON.stringify({}) });
						message.success('已提交AI获题，待审核');
						fetchList();
					} catch(e) {
						message.error(String(e.message || e));
					} finally {
						setAiLoading(false);
					}
				};

			const saveEdit = async () => {
				try {
					const v = await editForm.validateFields();
					await api('/questions/' + edit.id, { method:'PUT', body: JSON.stringify({ title: v.title||null, content: v.content }) });
					message.success('已保存');
					setEdit(null);
					fetchList();
				} catch(e) { message.error(String(e.message || e)); }
			};

			const delRow = async (id) => {
				try {
					await api('/questions/' + id, { method:'DELETE' });
					message.success('已删除');
					fetchList();
				} catch(e) { message.error(String(e.message || e)); }
			};

			const approveOne = async (id) => {
				try {
					await api('/questions/' + id + '/approve', { method:'POST' });
					message.success('已审核通过');
					fetchList();
				} catch(e) { message.error(String(e.message || e)); }
			};

			const approveMany = async () => {
				try {
					await api('/questions/approve-many', { method:'POST', body: JSON.stringify({ ids: selectedRowKeys }) });
					message.success('批量审核通过');
					setSelectedRowKeys([]);
					fetchList();
				} catch(e) { message.error(String(e.message || e)); }
			};

			const manualSubmit = async () => {
				try {
					const v = await manualForm.validateFields();
											await api('/questions/manual', { method:'POST', body: JSON.stringify({ title: v.title||null, content: v.content, type: v.type||'subjective', options: v.options||null, correctAnswers: v.correctAnswers||null, answer: v.answer||null }) });
					message.success('已提交，待审核');
					setManualOpen(false);
					manualForm.resetFields();
					fetchList();
				} catch(e) {
					if ((e.message||'').includes('409') || (e.message||'').includes('已存在')) {
						message.warning('题目已存在');
					} else {
						message.error(String(e.message || e));
					}
				}
			};

			return (
				<div>
					<Space style={{ marginBottom:12 }}>
						<Button type="primary" onClick={genQuick} loading={aiLoading}>AI获题</Button>
						<Button onClick={()=>setManualOpen(true)}>手工录入</Button>
						<Button onClick={approveMany} disabled={!selectedRowKeys.length}>批量审核通过</Button>
						<Button onClick={fetchList} loading={loading}>刷新</Button>
					</Space>
					<Table rowKey="id" loading={loading} columns={columns} dataSource={list} pagination={{ pageSize:8 }} rowSelection={{ selectedRowKeys, onChange:setSelectedRowKeys }} />


					<Modal title="手工录入" open={manualOpen} onOk={manualSubmit} onCancel={()=>setManualOpen(false)} okText="提交">
						<Form layout="vertical" form={manualForm}>
							<Form.Item name="title" label="标题">
								<Input placeholder="可选" />
							</Form.Item>
							<Form.Item name="type" label="题型" initialValue="subjective">
								<antd.Select options={[
									{label:'选择题', value:'choice'},
									{label:'填空题', value:'blank'},
									{label:'主观题', value:'subjective'}
								]} />
							</Form.Item>
							<Form.Item name="content" label="题干" rules={[{required:true, message:'请输入题干'}]}>
								<Input.TextArea autoSize={{ minRows:6 }} />
							</Form.Item>

							{(manualForm.getFieldValue('type')||'subjective')==='choice' && (
								<Card size="small" style={{marginBottom:12}} title="选项">
									<Form.List name="options">
										{(fields, { add, remove }) => (
											<div>
												{fields.map((field, idx) => (
													<div style={{display:'flex', gap:8, marginBottom:8}} key={field.key}>
														<Form.Item {...field} style={{flex:1}} rules={[{required:true, message:'请输入选项'}]}>
															<Input placeholder={`选项 ${idx+1}`} />
														</Form.Item>
														<Button danger onClick={()=>remove(field.name)}>删除</Button>
													</div>
												))}
												<Button onClick={()=>add('')}>新增选项</Button>
											</div>
										)}
									</Form.List>
									<Form.Item name="correctAnswers" label="正确答案（可多选）">
										<antd.Select mode="multiple" options={(manualForm.getFieldValue('options')||[]).map(o=>({label:o,value:o}))} />
									</Form.Item>
								</Card>
							)}

							{(manualForm.getFieldValue('type')||'subjective')==='blank' && (
								<Card size="small" style={{marginBottom:12}} title="填空答案">
									<Form.List name="correctAnswers">
										{(fields, { add, remove }) => (
											<div>
												{fields.map((field, idx) => (
													<div style={{display:'flex', gap:8, marginBottom:8}} key={field.key}>
														<Form.Item {...field} style={{flex:1}} rules={[{required:true, message:'请输入答案'}]}>
															<Input placeholder={`答案 ${idx+1}`} />
														</Form.Item>
														<Button danger onClick={()=>remove(field.name)}>删除</Button>
													</div>
												))}
												<Button onClick={()=>add('')}>新增答案</Button>
											</div>
										)}
									</Form.List>
								</Card>
							)}

							{(manualForm.getFieldValue('type')||'subjective')==='subjective' && (
								<Form.Item name="answer" label="参考答案">
									<Input.TextArea autoSize={{ minRows:6 }} />
								</Form.Item>
							)}
						</Form>
					</Modal>

					<Modal title="编辑题目" open={!!edit} onOk={saveEdit} onCancel={()=>setEdit(null)} okText="保存" width={800}>
						<Form layout="vertical" form={editForm}>
							<Form.Item name="title" label="标题">
								<Input placeholder="可选" />
							</Form.Item>
							<Form.Item name="type" label="题型" rules={[{required:true, message:'请选择题型'}]}>
								<antd.Select options={[
									{label:'选择题', value:'choice'},
									{label:'填空题', value:'blank'},
									{label:'主观题', value:'subjective'}
								]} />
							</Form.Item>
							<Form.Item name="content" label="题干" rules={[{required:true, message:'请输入题干'}]}>
								<Input.TextArea autoSize={{ minRows:8 }} />
							</Form.Item>

							{(editForm.getFieldValue('type')||'subjective')==='choice' && (
								<Card size="small" style={{marginBottom:12}} title="选项">
									<Form.List name="options">
										{(fields, { add, remove }) => (
											<div>
												{fields.map((field, idx) => (
													<div style={{display:'flex', gap:8, marginBottom:8}} key={field.key}>
														<Form.Item {...field} style={{flex:1}} rules={[{required:true, message:'请输入选项'}]}>
															<Input placeholder={`选项 ${idx+1}`} />
														</Form.Item>
														<Button danger onClick={()=>remove(field.name)}>删除</Button>
													</div>
												))}
												<Button onClick={()=>add('')}>新增选项</Button>
											</div>
										)}
									</Form.List>
									<Form.Item name="correctAnswers" label="正确答案（可多选）">
										<antd.Select mode="multiple" options={(editForm.getFieldValue('options')||[]).map(o=>({label:o,value:o}))} />
									</Form.Item>
								</Card>
							)}

							{(editForm.getFieldValue('type')||'subjective')==='blank' && (
								<Card size="small" style={{marginBottom:12}} title="填空答案">
									<Form.List name="correctAnswers">
										{(fields, { add, remove }) => (
											<div>
												{fields.map((field, idx) => (
													<div style={{display:'flex', gap:8, marginBottom:8}} key={field.key}>
														<Form.Item {...field} style={{flex:1}} rules={[{required:true, message:'请输入答案'}]}>
															<Input placeholder={`答案 ${idx+1}`} />
														</Form.Item>
														<Button danger onClick={()=>remove(field.name)}>删除</Button>
													</div>
												))}
												<Button onClick={()=>add('')}>新增答案</Button>
											</div>
										)}
									</Form.List>
								</Card>
							)}

							{(editForm.getFieldValue('type')||'subjective')==='subjective' && (
								<Form.Item name="answer" label="参考答案">
									<Input.TextArea autoSize={{ minRows:6 }} />
								</Form.Item>
							)}
						</Form>
					</Modal>
				</div>
			);
		}

		ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
	</script>
</body>
</html> 